{% extends 'layout.html' %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Cabecera con información de empresa -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="mb-0">
                            <i class="bi bi-calendar-week"></i> Dashboard de Turnos
                        </h2>
                        <p class="text-muted mb-0">{{ company.name }}</p>
                    </div>
                    <div>
                        <a href="{{ url_for('turnos.select_company') }}" class="btn btn-outline-primary">
                            <i class="bi bi-building"></i> Cambiar Empresa
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tarjetas de resumen -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card shadow-sm h-100 bg-gradient-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-0">Empleados</h6>
                            <h2 class="mt-2 mb-0">{{ empleados_count }}</h2>
                        </div>
                        <div>
                            <i class="bi bi-people fs-1"></i>
                        </div>
                    </div>
                    <p class="mt-3 mb-0">
                        <a href="{{ url_for('employee.list_employees', company_id=company.id) }}" class="text-white">
                            <i class="bi bi-arrow-right"></i> Ver empleados
                        </a>
                    </p>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card shadow-sm h-100 bg-gradient-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-0">Turnos Definidos</h6>
                            <h2 class="mt-2 mb-0">{{ turnos_count }}</h2>
                        </div>
                        <div>
                            <i class="bi bi-clock-history fs-1"></i>
                        </div>
                    </div>
                    <p class="mt-3 mb-0">
                        <a href="{{ url_for('turnos.listar_turnos', company_id=company.id) }}" class="text-white">
                            <i class="bi bi-arrow-right"></i> Ver turnos
                        </a>
                    </p>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card shadow-sm h-100 bg-gradient-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-0">Asignaciones Semana</h6>
                            <h2 class="mt-2 mb-0">{{ asignaciones_semana }}</h2>
                            <small>{{ inicio_semana.strftime('%d/%m') }} - {{ fin_semana.strftime('%d/%m') }}</small>
                        </div>
                        <div>
                            <i class="bi bi-calendar-check fs-1"></i>
                        </div>
                    </div>
                    <p class="mt-3 mb-0">
                        <a href="{{ url_for('turnos.calendario', company_id=company.id) }}" class="text-white">
                            <i class="bi bi-arrow-right"></i> Ver calendario
                        </a>
                    </p>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card shadow-sm h-100 bg-gradient-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-0">Ausencias Activas</h6>
                            <h2 class="mt-2 mb-0">{{ ausencias_activas }}</h2>
                        </div>
                        <div>
                            <i class="bi bi-calendar-x fs-1"></i>
                        </div>
                    </div>
                    <p class="mt-3 mb-0">
                        <a href="{{ url_for('turnos.listar_ausencias', company_id=company.id) }}" class="text-white">
                            <i class="bi bi-arrow-right"></i> Ver ausencias
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Acciones rápidas -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Acciones Rápidas</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                            <a href="{{ url_for('turnos.calendario', company_id=company.id) }}" class="btn btn-primary d-flex flex-column align-items-center w-100 h-100 p-3">
                                <i class="bi bi-calendar-week fs-1 mb-2"></i>
                                <span>Ver Calendario</span>
                            </a>
                        </div>
                        
                        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                            <a href="{{ url_for('turnos.asignar_horario', company_id=company.id) }}" class="btn btn-success d-flex flex-column align-items-center w-100 h-100 p-3">
                                <i class="bi bi-plus-circle fs-1 mb-2"></i>
                                <span>Asignar Turno</span>
                            </a>
                        </div>
                        
                        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                            <a href="{{ url_for('turnos.asignar_horario_masivo', company_id=company.id) }}" class="btn btn-info d-flex flex-column align-items-center w-100 h-100 p-3">
                                <i class="bi bi-clipboard-plus fs-1 mb-2"></i>
                                <span>Asignación Masiva</span>
                            </a>
                        </div>
                        
                        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                            <a href="{{ url_for('turnos.nueva_ausencia', company_id=company.id) }}" class="btn btn-warning d-flex flex-column align-items-center w-100 h-100 p-3">
                                <i class="bi bi-calendar-x fs-1 mb-2"></i>
                                <span>Registrar Ausencia</span>
                            </a>
                        </div>
                        
                        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                            <a href="{{ url_for('turnos.nuevo_turno', company_id=company.id) }}" class="btn btn-secondary d-flex flex-column align-items-center w-100 h-100 p-3">
                                <i class="bi bi-clock fs-1 mb-2"></i>
                                <span>Crear Turno</span>
                            </a>
                        </div>
                        
                        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                            <a href="{{ url_for('turnos.listar_plantillas', company_id=company.id) }}" class="btn btn-dark d-flex flex-column align-items-center w-100 h-100 p-3">
                                <i class="bi bi-layout-text-window fs-1 mb-2"></i>
                                <span>Plantillas</span>
                            </a>
                        </div>
                        
                        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                            <a href="{{ url_for('turnos.listar_requisitos', company_id=company.id) }}" class="btn btn-danger d-flex flex-column align-items-center w-100 h-100 p-3">
                                <i class="bi bi-people-fill fs-1 mb-2"></i>
                                <span>Requisitos de Personal</span>
                            </a>
                        </div>
                        
                        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                            <a href="{{ url_for('turnos.informes', company_id=company.id) }}" class="btn btn-primary d-flex flex-column align-items-center w-100 h-100 p-3">
                                <i class="bi bi-file-earmark-bar-graph fs-1 mb-2"></i>
                                <span>Informes</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Últimos cambios y actividad -->
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Últimos Cambios en Horarios</h5>
                </div>
                <div class="card-body">
                    {% if ultimos_cambios %}
                        <div class="list-group">
                            {% for cambio in ultimos_cambios %}
                                <div class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">
                                            {% if cambio.tipo_cambio == 'creacion' %}
                                                <span class="badge bg-success">Nueva asignación</span>
                                            {% elif cambio.tipo_cambio == 'modificacion' %}
                                                <span class="badge bg-warning">Modificación</span>
                                            {% elif cambio.tipo_cambio == 'eliminacion' %}
                                                <span class="badge bg-danger">Eliminación</span>
                                            {% endif %}
                                        </h6>
                                        <small class="text-muted">{{ cambio.fecha_cambio.strftime('%d/%m/%Y %H:%M') }}</small>
                                    </div>
                                    <p class="mb-1">{{ cambio.descripcion }}</p>
                                    <small class="text-muted">Realizado por: {{ cambio.user.username }}</small>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            No hay cambios registrados recientemente.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Vista Rápida del Calendario</h5>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <h4>Semana actual: {{ inicio_semana.strftime('%d/%m/%Y') }} - {{ fin_semana.strftime('%d/%m/%Y') }}</h4>
                        <a href="{{ url_for('turnos.calendario', company_id=company.id) }}" class="btn btn-primary mt-2">
                            <i class="bi bi-calendar-week"></i> Ver calendario completo
                        </a>
                    </div>
                    
                    <div class="d-flex flex-wrap justify-content-between mt-4">
                        {% for i in range(7) %}
                            {% set dia = inicio_semana + {'days': i}|timedelta %}
                            <div class="text-center mb-3" style="width: 14%;">
                                <div class="fw-bold">{{ dias_semana[i][:3] }}</div>
                                <div class="badge {% if dia == today %}bg-primary{% else %}bg-secondary{% endif %} rounded-circle p-2">
                                    {{ dia.strftime('%d') }}
                                </div>
                                <div class="mt-1 small">
                                    <a href="{{ url_for('turnos.asignar_horario', company_id=company.id, fecha=dia.strftime('%Y-%m-%d')) }}" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-plus-circle"></i>
                                    </a>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Obtener la fecha actual
    const today = new Date();
    const formattedDate = today.toISOString().split('T')[0];
    
    // Establecer como variable para el template
    document.addEventListener('DOMContentLoaded', function() {
        window.today = formattedDate;
    });
</script>
{% endblock %}